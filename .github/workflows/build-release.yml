name: Build and Release macOS App

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Using 3.11 for better compatibility
      
      - name: Install FFmpeg
        run: brew install ffmpeg
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build macOS application
        run: |
          python setup.py py2app
          mv dist/main.app "dist/Spotify to Apple Music Downloader.app"
      
      - name: Create DMG
        run: |
          APP_NAME="Spotify to Apple Music Downloader"
          APP_FILE="dist/${APP_NAME}.app"
          DMG_NAME="Spotify-to-Apple-Music-Downloader.dmg"
          VOLUME_NAME="Spotify to Apple Music Downloader"
          TEMP_DMG="temp.dmg"
          
          # Remove existing DMG if it exists
          rm -f "$DMG_NAME"
          
          # Create a temporary directory for DMG contents
          TEMP_DIR=$(mktemp -d)
          
          # Copy the app to temp directory
          cp -R "$APP_FILE" "$TEMP_DIR/"
          
          # Create a symbolic link to Applications folder
          ln -s /Applications "$TEMP_DIR/Applications"
          
          # Copy background image to a hidden folder
          mkdir -p "$TEMP_DIR/.background"
          cp images/background.png "$TEMP_DIR/.background/"
          
          # Create the temporary DMG
          hdiutil create \
              -volname "$VOLUME_NAME" \
              -srcfolder "$TEMP_DIR" \
              -ov \
              -format UDRW \
              "$TEMP_DMG"
          
          # Mount the temporary DMG
          MOUNT_DIR="/Volumes/$VOLUME_NAME"
          hdiutil attach "$TEMP_DMG" -nobrowse -quiet
          
          # Wait for mount
          sleep 2
          
          # Set DMG window properties using AppleScript
          osascript <<EOD
          tell application "Finder"
              tell disk "$VOLUME_NAME"
                  open
                  set current view of container window to icon view
                  set toolbar visible of container window to false
                  set statusbar visible of container window to false
                  set bounds of container window to {100, 100, 612, 454}
                  set arrangement of icon view options of container window to not arranged
                  set icon size of icon view options of container window to 64
                  set position of item "${APP_NAME}.app" of container window to {111, 136}
                  set position of item "Applications" of container window to {401, 136}
                  set background picture of icon view options of container window to file ".background:background.png"
                  update without registering applications
                  delay 2
                  close
              end tell
          end tell
          EOD
          
          # Unmount the temporary DMG
          hdiutil detach "$MOUNT_DIR" -quiet
          
          # Convert to compressed read-only DMG
          hdiutil convert "$TEMP_DMG" \
              -format UDZO \
              -o "$DMG_NAME"
          
          # Clean up
          rm -f "$TEMP_DMG"
          rm -rf "$TEMP_DIR"
          
          echo "DMG created successfully: $DMG_NAME"
      
      - name: Get version from commit
        id: get_version
        run: |
          VERSION="dev-$(git rev-parse --short HEAD)"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: spotify-to-apple-music-${{ steps.get_version.outputs.VERSION }}
          path: "*.dmg"
          retention-days: 30
  
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: build-macos
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
      
      - name: Install semantic-release dependencies
        run: |
          npm install semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/changelog @semantic-release/github @semantic-release/git
      
      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: spotify-to-apple-music-${{ needs.build-macos.outputs.version }}
          path: ./artifacts
      
      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
